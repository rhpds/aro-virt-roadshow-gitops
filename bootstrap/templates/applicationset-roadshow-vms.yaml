---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: roadshow-vms
  namespace: openshift-gitops
spec:
  goTemplate: true
  generators:
    - list:
        elements:
  {{- $userCount := int .Values.user.count }}
  {{- range $index := until $userCount }}
          - user: {{ $.Values.user.prefix }}{{ add $index 1}}
  {{- end }}
  template:
    metadata:
      name: 'roadshow-vms-{{`{{.user}}`}}'
    spec:
      project: default
      destination:
        server: https://kubernetes.default.svc
      source:
        repoURL: https://github.com/rhpds/aro-virt-roadshow-gitops.git
        targetRevision: main
        path: roadshow-vms
        helm:
          values: |
            namespace: vmimports-user{{`{{.user}}`}}
      ignoreDifferences:
        - group: "kubevirt.io"
          kind: "VirtualMachine"
          jsonPointers:
          - /spec/template/spec/domain/cpu
        - group: "apps"
          kind: "Deployment"
          jsonPointers:
          - /spec/replicas
          - /spec/template/spec/containers
      syncPolicy:
        automated: {}
        syncOptions:
          - CreateNamespace=true
