{{- $app := index .Values.applications "node_taint" }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: machineset-scale-job
  namespace: {{ $app.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "-2"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: machineset-scale-job
  annotations:
    argocd.argoproj.io/sync-wave: "-2"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: machineset-scale-job
  namespace: {{ $app.namespace }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: machineset-scale-job
  namespace: {{ $app.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "-2"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  template:
    spec:
      restartPolicy: Never
      serviceAccountName: machineset-scale-job
      containers:
      - name: machineset-scale-patch
        image: image-registry.openshift-image-registry.svc:5000/openshift/cli
        command:
        - /bin/sh
        - -c
        - |
          echo "######################"
          echo "# get all machineset names"
          echo "######################"

          MACHINESETS=($(oc get machinesets -o jsonpath='{.items[?(@.spec.template.spec.providerSpec.value.vmSize=="Standard_D16s_v3")].metadata.name}' --sort-by=.metadata.name -n openshift-machine-api -l machine.openshift.io/cluster-api-machine-role=worker))

          echo "######################"
          echo "# scale up across three machinesets"
          echo "######################"

          COUNT={{$.machinset_scale.count}}

          A=$((COUNT / 3 + (COUNT + 2) % 3))
          B=$((COUNT / 3 + (COUNT + 1) % 3))
          C=$((COUNT / 3))

          oc scale --replicas=$A machineset/${MACHINESETS[0]} -n openshift-machine-api
          oc scale --replicas=$B machineset/${MACHINESETS[1]} -n openshift-machine-api
          oc scale --replicas=$C machineset/${MACHINESETS[2]} -n openshift-machine-api
